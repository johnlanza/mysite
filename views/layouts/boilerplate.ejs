<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="/images/favicon.png" type="image/png" />

    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@400" />

    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" />

    <link
      href="https://fonts.cdnfonts.com/css/apple-garamond"
      rel="stylesheet" />

    <link
      href="https://fonts.googleapis.com/css2?family=Lexend:wght@100..900&display=swap"
      rel="stylesheet" />

    <link rel="stylesheet" href="/css/app.css" />
    <link
      href="https://cdn.quilljs.com/1.3.7/quill.snow.css"
      rel="stylesheet" />

    <title>John Lanza</title>

    <style>
      nav.simple-nav {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        margin-bottom: 1.5rem;
      }

      nav.simple-nav a {
        margin-right: 20px;
        font-size: 1.1rem;
        text-decoration: none;
        color: var(--text-color);
        font-family: "Lexend", sans-serif;
      }

      nav.simple-nav a:visited {
        color: var(--text-color);
      }

      nav.simple-nav a:hover {
        text-decoration: underline;
      }

      /* ----- MOBILE STACKING ----- */
      @media (max-width: 600px) {
        nav.simple-nav {
          flex-direction: column;
          align-items: flex-start;
        }

        nav.simple-nav a {
          margin: 6px 0;
        }
      }
    </style>
  </head>

  <body class="d-flex flex-column vh-100">
    <div class="container mt-5 px-3">
      <div class="row align-items-center">
        <div class="col">
          <!-- SITE HEADER -->
          <div class="brand-row">
            <h1>
              <a href="/" class="main-header">John Lanza</a>
            </h1>
            <img
              src="/images/john-portrait.jpg"
              alt="Portrait of John Lanza"
              class="main-header-portrait"
              loading="lazy" />
          </div>

          <!-- SIMPLE TOP NAV (now responsive) -->
          <nav class="simple-nav">
            <a href="/books">Book Summaries</a>
            <a href="/events">Timeline</a>
            <a href="/#books-written">Writing</a>
            <a
              href="https://category6consulting.com/speaker/john-lanza/"
              target="_blank">
              Speaking
            </a>
            <a href="/games">Games</a>
            <a href="#" id="colors-link">Colors</a>
          </nav>

          <!-- FLASH MESSAGES -->
          <% if (success && success.length > 0) { %>
          <div
            class="alert alert-success alert-dismissible fade show"
            role="alert">
            <%= success %>
            <button type="button" class="close" data-dismiss="alert">
              <span>&times;</span>
            </button>
          </div>
          <% } %> <% if (error && error.length > 0) { %>
          <div
            class="alert alert-danger alert-dismissible fade show"
            role="alert">
            <%= error %>
            <button type="button" class="close" data-dismiss="alert">
              <span>&times;</span>
            </button>
          </div>
          <% } %> <%- body %>
        </div>
      </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"></script>

    <script>
      (function () {
        const TOTAL_PALETTES = 4; // 0 = warm, 1 = Seahawks, 2 = peach/magenta, 3 = dark
        const STORAGE_KEY = "sitePaletteIndex";
        const MODE_KEY = "sitePaletteMode"; // "auto" | "manual"
        const CYCLE = [0, 1, 2, 3, "auto"]; // auto step lets users get back to automatic mode

        let currentPalette = 0;
        let currentMode = "auto";
        let cycleIndex = 0;
        let colorsLink = null;

        function applyPalette(index) {
          currentPalette = index;
          document.documentElement.setAttribute("data-palette", String(index));
          updateColorsLinkLabel();
        }

        function saveMode(mode) {
          try {
            localStorage.setItem(MODE_KEY, mode);
          } catch (e) {
            // ignore storage errors
          }
        }

        function savePalette(index) {
          try {
            localStorage.setItem(STORAGE_KEY, String(index));
          } catch (e) {
            // ignore storage errors
          }
        }

        function clearPalette() {
          try {
            localStorage.removeItem(STORAGE_KEY);
          } catch (e) {
            // ignore storage errors
          }
        }

        function getStoredSettings() {
          let mode = "auto";
          let palette = null;

          try {
            const storedMode = localStorage.getItem(MODE_KEY);
            if (storedMode === "manual") {
              mode = "manual";
            }

            const rawPalette = localStorage.getItem(STORAGE_KEY);
            const parsed = parseInt(rawPalette, 10);
            if (!Number.isNaN(parsed) && parsed >= 0 && parsed < TOTAL_PALETTES) {
              palette = parsed;
            }
          } catch (e) {
            // ignore localStorage issues
          }

          return { mode, palette };
        }

        function updateColorsLinkLabel() {
          if (!colorsLink) return;
          const paletteLabels = ["Warm", "Seahawks", "Peach", "Dark"];
          if (currentMode === "auto") {
            colorsLink.textContent = "Colors (Auto)";
            return;
          }

          const label = paletteLabels[currentPalette] || "Manual";
          colorsLink.textContent = "Colors (" + label + ")";
        }

        function calculateSunTime(date, lat, lon, isSunrise) {
          const toRad = (deg) => (Math.PI / 180) * deg;
          const toDeg = (rad) => (180 / Math.PI) * rad;

          const year = date.getUTCFullYear();
          const month = date.getUTCMonth();
          const day = date.getUTCDate();

          // Day of year (1-366)
          const N1 = Math.floor((275 * (month + 1)) / 9);
          const N2 = Math.floor((month + 1 + 9) / 12);
          const N3 = 1 + Math.floor((year - 4 * Math.floor(year / 4) + 2) / 3);
          const N = N1 - N2 * N3 + day - 30;

          const lngHour = lon / 15;
          const t = N + ((isSunrise ? 6 : 18) - lngHour) / 24;

          const M = 0.9856 * t - 3.289;
          let L =
            M +
            1.916 * Math.sin(toRad(M)) +
            0.020 * Math.sin(toRad(2 * M)) +
            282.634;
          L = (L + 360) % 360;

          let RA = toDeg(Math.atan(0.91764 * Math.tan(toRad(L))));
          RA = (RA + 360) % 360;

          const Lquadrant = Math.floor(L / 90) * 90;
          const RAquadrant = Math.floor(RA / 90) * 90;
          RA = (RA + (Lquadrant - RAquadrant)) / 15;

          const sinDec = 0.39782 * Math.sin(toRad(L));
          const cosDec = Math.cos(Math.asin(sinDec));

          const cosH =
            (Math.cos(toRad(90.833)) - sinDec * Math.sin(toRad(lat))) /
            (cosDec * Math.cos(toRad(lat)));

          if (cosH > 1 || cosH < -1) return null; // polar day/night

          let H = Math.acos(cosH);
          H = isSunrise ? 360 - toDeg(H) : toDeg(H);
          H /= 15;

          const T = H + RA - 0.06571 * t - 6.622;
          const UT = (T - lngHour + 24) % 24;

          const hour = Math.floor(UT);
          const minute = Math.round((UT - hour) * 60);
          const utcDate = Date.UTC(year, month, day, hour, minute);
          return new Date(utcDate - date.getTimezoneOffset() * 60000);
        }

        function getSunTimes(date, lat, lon) {
          const sunrise = calculateSunTime(date, lat, lon, true);
          const sunset = calculateSunTime(date, lat, lon, false);
          return { sunrise, sunset };
        }

        function isAfterSunset(now, times) {
          if (!times) return null;
          const { sunrise, sunset } = times;
          if (sunrise && sunset) {
            return now >= sunset || now < sunrise;
          }
          if (sunset) {
            return now >= sunset;
          }
          return null;
        }

        function applyAutoPalette() {
          // If geolocation fails, fall back to a simple local-time band.
          const now = new Date();
          const timeBasedDark = now.getHours() >= 19 || now.getHours() < 6;
          applyPalette(timeBasedDark ? 3 : 0);

          if (!navigator.geolocation) return;

          navigator.geolocation.getCurrentPosition(
            function (pos) {
              const { latitude, longitude } = pos.coords;
              const times = getSunTimes(new Date(), latitude, longitude);
              const shouldBeDark = isAfterSunset(new Date(), times);

              if (shouldBeDark === true) {
                applyPalette(3);
              } else if (shouldBeDark === false) {
                applyPalette(0);
              }
            },
            function () {
              // geolocation denied/failed; keep fallback choice
            },
            { maximumAge: 6 * 60 * 60 * 1000, timeout: 5000 }
          );
        }

        function setManualPalette(index) {
          currentMode = "manual";
          applyPalette(index);
          savePalette(index);
          saveMode("manual");
          cycleIndex = Math.max(0, CYCLE.indexOf(index));
        }

        function setAutoMode() {
          currentMode = "auto";
          clearPalette();
          saveMode("auto");
          cycleIndex = CYCLE.indexOf("auto");
          applyAutoPalette();
        }

        document.addEventListener("DOMContentLoaded", function () {
          colorsLink = document.getElementById("colors-link");

          const stored = getStoredSettings();
          if (stored.mode === "manual" && stored.palette !== null) {
            setManualPalette(stored.palette);
            cycleIndex = Math.max(0, CYCLE.indexOf(stored.palette));
          } else {
            setAutoMode();
          }

          if (!colorsLink) return;

          colorsLink.addEventListener("click", function (event) {
            event.preventDefault();
            cycleIndex = (cycleIndex + 1) % CYCLE.length;
            const next = CYCLE[cycleIndex];
            if (next === "auto") {
              setAutoMode();
            } else {
              setManualPalette(next);
            }
          });
        });
      })();
    </script>
  </body>
</html>
