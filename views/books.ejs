<h1>My Book Summaries</h1>

<div class="container"></div>

<style>
  /* Book header + image behavior */
  .book .book-header {
    padding-top: 0 !important;
    padding-bottom: 0 !important;
    height: 110px; /* matches games card height you liked */
    overflow: hidden;
    align-items: stretch;
    gap: 8px;
  }

  .book .book-text {
    cursor: pointer;
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
  }

  .book .book-header h3,
  .book .book-header h4 {
    margin-top: 4px;
    margin-bottom: 4px;
  }

  .book .book-image-wrapper {
    cursor: pointer;
    margin-right: 4px;
    display: flex;
    align-items: stretch;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.15s ease;
  }

  /* Show image on hover or when expanded */
  .book:hover .book-image-wrapper,
  .book.expanded .book-image-wrapper {
    opacity: 1;
    pointer-events: auto;
  }

  .book .book-image-wrapper img {
    display: block;
    height: 100%;
    width: auto;
  }
</style>

<section>
  <% if (currentUser) { %>
  <a href="/books/newbook">Add a Book</a>
  <% } %> <% if (typeof errorMessage !== "undefined" && errorMessage) { %>
  <p style="color: red; font-weight: bold; margin-bottom: 20px">
    <%= errorMessage %>
  </p>
  <% } %>

  <p>
    I'm adding all my book summaries here as I complete them. (And as time
    permits.)
  </p>

  <% for (let book of books) { %>
  <div class="book" id="book-<%= book._id %>">
    <div
      class="book-header"
      style="display: flex; justify-content: space-between">
      <section class="book-text" onclick="toggleDetails('<%= book._id %>')">
        <h3 style="font-style: italic; cursor: pointer"><%= book.title %></h3>

        <h4 style="font-style: italic; cursor: pointer; margin: 0">
          by <%= book.author %>
        </h4>
      </section>

      <% if (book.imageUrl) { %>
      <div
        class="book-image-wrapper"
        onclick="toggleDetails('<%= book._id %>')">
        <img src="<%= book.imageUrl %>" alt="Cover of <%= book.title %>" />
      </div>
      <% } %>

      <button
        class="toggle-btn"
        onclick="toggleDetails('<%= book._id %>')"
        style="
          background: none;
          border: none;
          cursor: pointer;
          font-size: 32px;
        ">
        â†§
      </button>
    </div>

    <div
      id="details-<%= book._id %>"
      class="book-details"
      style="display: none; margin-left: 5px">
      <p><strong>Summary:</strong> <%= book.summary %></p>

      <% if (book.notes) { %>
      <div class="notes" style="min-height: 100px"><%- book.notes %></div>
      <% } %>

      <p>
        <a href="<%= book.link %>" target="_blank">Goodreads</a>

        <!-- Modern safe Share button -->
        <a
          href="#"
          class="share-btn"
          data-slug="<%= book.slug %>"
          data-title="<%- book.title %>"
          data-author="<%- book.author %>">
          Share
        </a>
      </p>

      <% if (currentUser) { %>
      <p>
        <a href="/books/<%= book._id %>/editbook" style="margin-right: 10px">
          Edit
        </a>
        <a href="#" onclick="deleteBook('<%= book._id %>')">Delete</a>
      </p>
      <% } %>
    </div>
  </div>
  <% } %> <% if (currentUser) { %>
  <a href="/books/newbook">Add a Book</a>
  <% } %>
</section>

<script>
  const sharedSlug = "<%= sharedSlug || '' %>";
</script>

<script>
  let currentExpanded = null;

  function toggleDetails(bookId, skipUrlUpdate = false) {
    const details = document.getElementById(`details-${bookId}`);
    const bookElement = document.getElementById(`book-${bookId}`);
    const isVisible = details.style.display === "block";

    // Collapse previous
    if (currentExpanded && currentExpanded !== details) {
      currentExpanded.style.display = "none";
      const prevBtn =
        currentExpanded.previousElementSibling.querySelector(".toggle-btn");
      if (prevBtn) prevBtn.textContent = "â†§";

      const prevBook = currentExpanded.parentElement;
      if (prevBook && prevBook.classList) {
        prevBook.classList.remove("expanded");
      }
    }

    if (!isVisible) {
      details.style.display = "block";
      const btn = details.previousElementSibling.querySelector(".toggle-btn");
      if (btn) btn.textContent = "ðŸ”";
      currentExpanded = details;

      if (bookElement && bookElement.classList) {
        bookElement.classList.add("expanded");
      }

      if (!skipUrlUpdate) {
        const url = new URL(window.location);
        url.searchParams.set("book", bookId);
        url.hash = bookId;
        window.history.pushState({}, "", url);
      }

      bookElement.scrollIntoView({ behavior: "smooth", block: "start" });
    } else {
      details.style.display = "none";
      const btn = details.previousElementSibling.querySelector(".toggle-btn");
      if (btn) btn.textContent = "â†§";
      currentExpanded = null;

      if (bookElement && bookElement.classList) {
        bookElement.classList.remove("expanded");
      }

      if (!skipUrlUpdate) {
        const url = new URL(window.location);
        url.searchParams.delete("book");
        url.hash = "";
        window.history.pushState({}, "", url);
      }
    }
  }

  function shareBook(slug, title, author) {
    const shareUrl = `${window.location.origin}/books/${slug}`;
    const shareText = `Summary and notes for "${title}" by ${author} â€” worth reading.`;

    if (navigator.share) {
      navigator
        .share({ title, text: shareText, url: shareUrl })
        .catch(() => {});
    } else {
      navigator.clipboard.writeText(`${shareText}\n${shareUrl}`).then(() => {
        alert("Link copied to clipboard!");
      });
    }
  }

  // Modern, safe event delegation for Share button
  document.addEventListener("click", function (e) {
    if (e.target.classList.contains("share-btn")) {
      e.preventDefault();
      const slug = e.target.dataset.slug;
      const title = e.target.dataset.title;
      const author = e.target.dataset.author;
      shareBook(slug, title, author);
    }
  });

  window.onload = async function () {
    const params = new URLSearchParams(window.location.search);
    const bookId = params.get("book");

    if (bookId) {
      setTimeout(() => toggleDetails(bookId), 50);
      setTimeout(() => scrollToBook(bookId), 200);
      return;
    }

    if (sharedSlug) {
      try {
        const response = await fetch(`/books/book-id-from-slug/${sharedSlug}`);
        if (!response.ok) return;
        const { id } = await response.json();
        setTimeout(() => toggleDetails(id, true), 50);
        setTimeout(() => scrollToBook(id), 200);
      } catch (err) {
        console.error("Error resolving slug:", err);
      }
    }
  };

  function scrollToBook(bookId) {
    const el = document.getElementById(`book-${bookId}`);
    if (el) el.scrollIntoView({ behavior: "smooth", block: "start" });
  }
</script>

<script>
  async function deleteBook(bookId) {
    try {
      const response = await fetch(`/books/${bookId}`, { method: "DELETE" });
      if (response.ok) {
        window.location.href = "/books";
      } else {
        console.error("Failed to delete");
      }
    } catch (err) {
      console.error("Delete error:", err);
    }
  }
</script>

<div class="container" style="padding-left: 5px">
  <h2>Events</h2>
  <section>
    <% if (currentUser) { %>
    <a href="/events/newevent">Add Event</a>
    <% } %>
    <p></p>
    <ul style="padding-left: 5px">
      <% for (let event of events) { %>
      <li>
        In <%= event.year %>, <%- event.description %> <% if (currentUser) { %>
        <a href="/events/<%= event._id %>/editevent">Edit</a>
        <a href="#" onclick="deleteEvent('<%= event._id %>')">Delete</a>
        <% } %>
      </li>
      <% } %>
    </ul>
    <% if (currentUser) { %>
    <a href="/events/newevent">Add Event</a>
    <% } %>
  </section>
</div>

<script>
  async function deleteEvent(eventId) {
    try {
      const response = await fetch(`/events/${eventId}`, {
        method: "DELETE",
      });

      if (response.ok) {
        window.location.href = "/events";
      } else {
        console.error("Failed to delete event");
      }
    } catch (error) {
      console.error("Error deleting event:", error);
    }
  }
</script>
