<h1>My Book Summaries</h1>

<div class="container"></div>

<style>
  /* Fixed-height header with text + image + arrow */

  .book .book-header {
    display: flex !important;
    justify-content: space-between !important;
    align-items: center !important;
    gap: 8px !important;
    height: 110px !important; /* fixed height */
    overflow: hidden !important; /* crop anything that doesn't fit */
    padding: 0 16px 0 5px !important; /* NO vertical padding so image touches top/bottom */
  }

  /* Text column: title on top, author at bottom */
  .book .book-text {
    cursor: pointer;
    flex: 1 1 auto !important;
    height: 100% !important;
    display: flex !important;
    flex-direction: column !important;
    justify-content: space-between !important;
    overflow: hidden !important; /* text can't bleed under image/arrow */
    padding-top: 20px !important; /* vertical padding lives here */
    padding-bottom: 8px !important;
  }

  /* TITLE in header: single line, ellipsis */
  .book .book-title h3 {
    margin: 0 0 4px 0 !important;
    line-height: 1.2 !important;
    white-space: nowrap !important;
    overflow: hidden !important;
    text-overflow: ellipsis !important;
    font-style: italic;
    cursor: pointer;
  }

  /* AUTHOR in header: always visible under the title */
  .book .book-author h4 {
    margin: 0 !important;
    line-height: 1.2 !important;
    font-style: italic;
    cursor: pointer;
    white-space: nowrap !important;
    overflow: hidden !important;
    text-overflow: ellipsis !important;
  }

  /* Image wrapper: fixed width so text knows its limit, flush with bar */
  .book .book-image-wrapper {
    cursor: pointer;
    display: flex !important;
    align-items: stretch !important;
    flex: 0 0 64px !important; /* fixed width for image */
    height: 100% !important; /* fills header height (bar height) */
    margin-left: 8px;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.15s ease;
  }

  .book:hover .book-image-wrapper,
  .book.expanded .book-image-wrapper {
    opacity: 1;
    pointer-events: auto;
  }

  .book .book-image-wrapper img {
    display: block !important;
    height: 100% !important; /* align top/bottom with bar */
    width: auto !important; /* allow full cover width */
  }

  /* Arrow button: fixed width so it's not squeezed */
  .book .book-header .toggle-btn {
    flex: 0 0 32px !important;
    margin-left: 8px !important;
    background: none;
    border: none;
    cursor: pointer;
    padding: 0;
  }

  /* Material icon styling */
  .book .toggle-btn .material-symbols-outlined {
    font-variation-settings: "FILL" 0, "wght" 400, "GRAD" 0, "opsz" 24;
    font-size: 24px;
    vertical-align: middle;
  }

  /* DETAILS: full title + author with normal wrapping (no ellipsis) */
  .book-details h3 {
    white-space: normal !important;
    overflow: visible !important;
    text-overflow: clip !important;
    margin-top: 8px;
  }

  .book-details h4 {
    margin-top: 0;
  }

  /* Share modal */
  .share-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 999;
    display: block;
  }

  .share-modal {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: #fff;
    border-radius: 10px;
    box-shadow: 0 12px 28px rgba(0, 0, 0, 0.25);
    width: min(520px, 90vw);
    max-height: 90vh;
    overflow: auto;
    padding: 20px;
    display: block;
    z-index: 1000;
  }

  .share-modal h3 {
    margin: 0 0 8px 0;
  }

  .share-modal .share-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 8px;
  }

  .share-modal .share-modal-header button {
    background: transparent;
    border: none;
    font-size: 22px;
    cursor: pointer;
  }

  .share-option {
    margin: 12px 0;
  }

  .share-option label {
    display: block;
    margin-bottom: 6px;
    cursor: pointer;
  }

  @media (max-width: 640px) {
    .book .book-header {
      height: auto !important;
      padding-top: 10px !important;
      padding-bottom: 10px !important;
      gap: 4px !important;
    }

    .book .book-text {
      padding-top: 0 !important;
      padding-bottom: 0 !important;
      justify-content: center !important;
      gap: 4px !important;
      min-width: 0; /* allow text to use available space */
    }

    .book .book-title h3,
    .book .book-author h4 {
      white-space: nowrap !important;
      overflow: hidden !important;
      text-overflow: ellipsis !important;
    }

    .book .book-image-wrapper {
      display: none !important; /* reclaim text width on mobile */
      flex: 0 0 0 !important;
    }

    .book .book-header .toggle-btn {
      flex: 0 0 28px !important;
    }
  }

  .share-note-picker {
    margin: 8px 0 14px 0;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 8px;
    max-height: 200px;
    overflow: auto;
    background: #fafafa;
  }

  .share-note {
    display: flex;
    align-items: flex-start;
    gap: 8px;
    margin-bottom: 8px;
  }

  .share-note span {
    display: block;
    line-height: 1.4;
  }

  .share-actions {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
  }

  .share-actions button {
    cursor: pointer;
    padding: 8px 14px;
    border-radius: 6px;
    border: 1px solid #ccc;
    background: #f6f6f6;
  }

  .share-actions button.primary {
    background: #0077cc;
    border-color: #0062a8;
    color: #fff;
  }

  .hidden {
    display: none !important;
  }
</style>

<section>
  <% if (currentUser) { %>
  <a href="/books/newbook">Add a Book</a>
  <% } %> <% if (typeof errorMessage !== "undefined" && errorMessage) { %>
  <p style="color: red; font-weight: bold; margin-bottom: 20px">
    <%= errorMessage %>
  </p>
  <% } %>

  <p>
    I'm adding all my book summaries here as I complete them. (And as time
    permits.)
  </p>

  <% for (let book of books) { %>
  <div class="book" id="book-<%= book._id %>">
    <div class="book-header">
      <section class="book-text" onclick="toggleDetails('<%= book._id %>')">
        <div class="book-title">
          <h3><%= book.title %></h3>
        </div>

        <div class="book-author">
          <h4>by <%= book.author %></h4>
        </div>
      </section>

      <% if (book.imageUrl) { %>
      <div
        class="book-image-wrapper"
        onclick="toggleDetails('<%= book._id %>')">
        <img src="<%= book.imageUrl %>" alt="Cover of <%= book.title %>" />
      </div>
      <% } %>

      <button
        class="toggle-btn"
        onclick="toggleDetails('<%= book._id %>')"
        aria-label="Show details">
        <span class="material-symbols-outlined">expand_more</span>
      </button>
    </div>

    <div
      id="details-<%= book._id %>"
      class="book-details"
      style="display: none; margin-left: 5px; overflow: visible">
      <!-- Full title + author in expanded view (NO truncation here) -->
      <p
        style="
          font-style: italic;
          font-size: 1.2em;
          margin: 8px 0 4px 0;
          white-space: normal;
          overflow: visible;
          text-overflow: clip;
        ">
        <%= book.title %>
      </p>
      <p style="font-style: italic; margin: 0 0 8px 0">by <%= book.author %></p>

      <p>
        <strong>Summary:</strong>
        <span class="summary-text"><%= book.summary %></span>
      </p>

      <% if (book.notes) { %>
      <div class="notes" style="min-height: 100px"><%- book.notes %></div>
      <% } %>

      <p>
        <a href="<%= book.link %>" target="_blank">Goodreads</a>

        <!-- Modern safe Share button -->
        <a
          href="#"
          class="share-btn"
          data-book-id="<%= book._id %>"
          data-slug="<%= book.slug %>"
          data-title="<%- book.title %>"
          data-author="<%- book.author %>"
          data-image="<%- book.imageUrl || '' %>">
          Share
        </a>
      </p>

      <% if (currentUser) { %>
      <p>
        <a href="/books/<%= book._id %>/editbook" style="margin-right: 10px">
          Edit
        </a>
        <a href="#" onclick="deleteBook('<%= book._id %>')">Delete</a>
      </p>
      <% } %>
    </div>
  </div>
  <% } %> <% if (currentUser) { %>
  <a href="/books/newbook">Add a Book</a>
  <% } %>
</section>

<div id="share-overlay" class="share-overlay hidden"></div>
<div
  id="share-modal"
  class="share-modal hidden"
  role="dialog"
  aria-modal="true"
  aria-labelledby="share-modal-title">
  <div class="share-modal-header">
    <h3 id="share-modal-title"></h3>
    <button type="button" id="share-close-btn" aria-label="Close share dialog">
      &times;
    </button>
  </div>

  <form id="share-form">
    <div class="share-option">
      <label>
        <input type="checkbox" id="share-summary" checked />
        Include summary
      </label>
    </div>

    <div class="share-option">
      <p style="margin: 0 0 6px 0; font-weight: bold">Notes</p>
      <label>
        <input type="radio" name="share-notes-mode" value="none" />
        No notes
      </label>
      <label>
        <input type="radio" name="share-notes-mode" value="all" checked />
        All notes
      </label>
      <label>
        <input type="radio" name="share-notes-mode" value="select" />
        Choose notes
      </label>
    </div>

    <div id="share-note-picker" class="share-note-picker"></div>

    <div class="share-actions">
      <button type="button" id="share-cancel-btn">Cancel</button>
      <button type="submit" class="primary">Share</button>
    </div>
  </form>
</div>

<script>
  const sharedSlug = "<%= sharedSlug || '' %>";
</script>

<script>
  let currentExpanded = null;

  function toggleDetails(bookId, skipUrlUpdate = false) {
    const details = document.getElementById(`details-${bookId}`);
    const bookElement = document.getElementById(`book-${bookId}`);
    const isVisible = details.style.display === "block";

    // Collapse previous
    if (currentExpanded && currentExpanded !== details) {
      currentExpanded.style.display = "none";

      const prevHeader = currentExpanded.previousElementSibling;
      if (prevHeader) {
        const prevBtn = prevHeader.querySelector(".toggle-btn");
        if (prevBtn) {
          const prevIcon = prevBtn.querySelector(".material-symbols-outlined");
          if (prevIcon) prevIcon.textContent = "expand_more";
        }
      }

      const prevBook = currentExpanded.parentElement;
      if (prevBook && prevBook.classList) {
        prevBook.classList.remove("expanded");
      }
    }

    if (!isVisible) {
      details.style.display = "block";
      const header = details.previousElementSibling;
      const btn = header ? header.querySelector(".toggle-btn") : null;
      if (btn) {
        const icon = btn.querySelector(".material-symbols-outlined");
        if (icon) icon.textContent = "expand_less";
      }
      currentExpanded = details;

      if (bookElement && bookElement.classList) {
        bookElement.classList.add("expanded");
      }

      if (!skipUrlUpdate) {
        const url = new URL(window.location);
        url.searchParams.set("book", bookId);
        url.hash = bookId;
        window.history.pushState({}, "", url);
      }

      bookElement.scrollIntoView({ behavior: "smooth", block: "start" });
    } else {
      details.style.display = "none";
      const header = details.previousElementSibling;
      const btn = header ? header.querySelector(".toggle-btn") : null;
      if (btn) {
        const icon = btn.querySelector(".material-symbols-outlined");
        if (icon) icon.textContent = "expand_more";
      }
      currentExpanded = null;

      if (bookElement && bookElement.classList) {
        bookElement.classList.remove("expanded");
      }

      if (!skipUrlUpdate) {
        const url = new URL(window.location);
        url.searchParams.delete("book");
        url.hash = "";
        window.history.pushState({}, "", url);
      }
    }
  }

  const shareOverlay = document.getElementById("share-overlay");
  const shareModal = document.getElementById("share-modal");
  const shareModalTitle = document.getElementById("share-modal-title");
  const shareSummaryCheckbox = document.getElementById("share-summary");
  const shareNotePicker = document.getElementById("share-note-picker");
  const shareForm = document.getElementById("share-form");
  const shareCancelBtn = document.getElementById("share-cancel-btn");
  const shareCloseBtn = document.getElementById("share-close-btn");

  function getSummaryText(bookId) {
    const summaryEl = document.querySelector(
      `#details-${bookId} .summary-text`
    );
    return summaryEl ? summaryEl.innerText.trim() : "";
  }

  function parseNotes(notesEl) {
    if (!notesEl) return [];

    const listItems = Array.from(notesEl.querySelectorAll("li"))
      .map((li) => li.innerText.trim())
      .filter(Boolean);

    if (listItems.length) return listItems;

    return notesEl.innerText
      .split(/\n+/)
      .map((line) => line.trim())
      .filter(Boolean);
  }

  function buildNotePicker(notes) {
    shareNotePicker.innerHTML = "";

    if (!notes.length) {
      const empty = document.createElement("p");
      empty.textContent = "No notes available for this book.";
      empty.style.margin = "0";
      empty.style.color = "#666";
      shareNotePicker.appendChild(empty);
      return;
    }

    notes.forEach((note, idx) => {
      const label = document.createElement("label");
      label.className = "share-note";

      const input = document.createElement("input");
      input.type = "checkbox";
      input.name = "share-note";
      input.value = note;
      input.checked = true;
      input.id = `note-${idx}`;

      const textSpan = document.createElement("span");
      textSpan.textContent = note;

      label.appendChild(input);
      label.appendChild(textSpan);
      shareNotePicker.appendChild(label);
    });
  }

  function setNotesMode(mode, notesExist) {
    const noteRadios = document.querySelectorAll('input[name="share-notes-mode"]');
    noteRadios.forEach((radio) => {
      radio.disabled = !notesExist && radio.value !== "none";
      radio.checked =
        radio.value === (notesExist ? mode : "none");
    });

    shareNotePicker.style.display =
      notesExist ? (mode === "select" ? "block" : "none") : "block";
  }

  function openShareModal({ slug, title, author, bookId, image }) {
    const details = document.getElementById(`details-${bookId}`);
    const notesEl = details ? details.querySelector(".notes") : null;
    const notes = parseNotes(notesEl);
    const summaryText = getSummaryText(bookId);

    shareModal.dataset.slug = slug;
    shareModal.dataset.title = title;
    shareModal.dataset.author = author;
    shareModal.dataset.bookId = bookId;
    shareModal.dataset.image = image || "";

    shareModalTitle.textContent = `Share "${title}"`;
    shareSummaryCheckbox.checked = Boolean(summaryText);
    shareSummaryCheckbox.disabled = summaryText.length === 0;

    buildNotePicker(notes);
    setNotesMode(notes.length ? "all" : "none", notes.length > 0);

    shareOverlay.classList.remove("hidden");
    shareModal.classList.remove("hidden");
    document.body.style.overflow = "hidden";
  }

  function closeShareModal() {
    shareOverlay.classList.add("hidden");
    shareModal.classList.add("hidden");
    document.body.style.overflow = "";
  }

  document.addEventListener("click", function (e) {
    if (e.target.classList.contains("share-btn")) {
      e.preventDefault();
      const slug = e.target.dataset.slug;
      const title = e.target.dataset.title;
      const author = e.target.dataset.author;
      const bookId = e.target.dataset.bookId;
      const image = e.target.dataset.image || "";
      openShareModal({ slug, title, author, bookId, image });
    }
  });

  shareOverlay.addEventListener("click", closeShareModal);
  shareCancelBtn.addEventListener("click", closeShareModal);
  shareCloseBtn.addEventListener("click", closeShareModal);

  async function getShareFiles(imageUrl, slug) {
    if (!imageUrl) return [];
    try {
      const res = await fetch(imageUrl, { mode: "cors" });
      if (!res.ok) throw new Error("Failed to fetch image");
      const blob = await res.blob();
      const extension = blob.type.split("/")[1] || "jpg";
      const file = new File([blob], `book-${slug}.${extension}`, {
        type: blob.type,
      });
      return [file];
    } catch (err) {
      console.warn("Could not load image for sharing:", err);
      return [];
    }
  }

  document
    .querySelectorAll('input[name="share-notes-mode"]')
    .forEach((radio) => {
      radio.addEventListener("change", () => {
        const mode = radio.value;
        const hasNotes =
          shareNotePicker.querySelectorAll('input[name="share-note"]').length >
          0;
        setNotesMode(mode, hasNotes);

        // When switching to "Choose notes", start with nothing selected
        if (mode === "select") {
          shareNotePicker
            .querySelectorAll('input[name="share-note"]')
            .forEach((cb) => {
              cb.checked = false;
            });
        }
      });
    });

  shareForm.addEventListener("submit", async function (e) {
    e.preventDefault();
    const slug = shareModal.dataset.slug;
    const title = shareModal.dataset.title;
    const author = shareModal.dataset.author;
    const bookId = shareModal.dataset.bookId;
    const image = shareModal.dataset.image;
    const includeSummary = shareSummaryCheckbox.checked;
    const summaryText = includeSummary ? getSummaryText(bookId) : "";

    const noteMode =
      document.querySelector('input[name="share-notes-mode"]:checked')
        ?.value || "none";

    const details = document.getElementById(`details-${bookId}`);
    const notesEl = details ? details.querySelector(".notes") : null;
    const allNotes = parseNotes(notesEl);

    let selectedNotes = [];
    if (noteMode === "all") {
      selectedNotes = allNotes;
    } else if (noteMode === "select") {
      selectedNotes = Array.from(
        shareNotePicker.querySelectorAll('input[name="share-note"]:checked')
      ).map((cb) => cb.value);
    }

    if (!summaryText && !selectedNotes.length) {
      alert("Select something to share (summary or notes).");
      return;
    }

    const shareParts = [];
    if (summaryText) shareParts.push(`Summary:\n${summaryText}`);
    if (selectedNotes.length) {
      shareParts.push(`Selected notes:\n- ${selectedNotes.join("\n- ")}`);
    }

    const shareUrl = `${window.location.origin}/books/${slug}`;
    let shareText = `Here is some information about "${title}" by ${author} I thought you might find interesting.`;
    if (shareParts.length) {
      shareText += `\n\n${shareParts.join("\n\n")}`;
    }
    shareText += `\n\n${shareUrl}`;
    if (image) {
      shareText += `\n${image}`;
    }

    let shareData = { title: `Sharing notes on ${title}`, text: shareText };
    const files = await getShareFiles(image, slug);
    if (
      files.length &&
      navigator.canShare &&
      navigator.canShare({ files })
    ) {
      shareData.files = files;
    }

    if (navigator.share) {
      try {
        await navigator.share(shareData);
      } catch (err) {
        // Retry without files if files caused the failure
        if (shareData.files) {
          delete shareData.files;
          try {
            await navigator.share(shareData);
          } catch (err2) {}
        }
      }
    } else {
      navigator.clipboard.writeText(shareText).then(() => {
        alert("Selection copied to your clipboard.");
      });
    }

    closeShareModal();
  });

  window.onload = async function () {
    const params = new URLSearchParams(window.location.search);
    const bookId = params.get("book");

    if (bookId) {
      setTimeout(() => toggleDetails(bookId), 50);
      setTimeout(() => scrollToBook(bookId), 200);
      return;
    }

    if (sharedSlug) {
      try {
        const response = await fetch(`/books/book-id-from-slug/${sharedSlug}`);
        if (!response.ok) return;
        const { id } = await response.json();
        setTimeout(() => toggleDetails(id, true), 50);
        setTimeout(() => scrollToBook(id), 200);
      } catch (err) {
        console.error("Error resolving slug:", err);
      }
    }
  };

  function scrollToBook(bookId) {
    const el = document.getElementById(`book-${bookId}`);
    if (el) el.scrollIntoView({ behavior: "smooth", block: "start" });
  }
</script>

<script>
  async function deleteBook(bookId) {
    try {
      const response = await fetch(`/books/${bookId}`, { method: "DELETE" });
      if (response.ok) {
        window.location.href = "/books";
      } else {
        console.error("Failed to delete");
      }
    } catch (err) {
      console.error("Delete error:", err);
    }
  }
</script>
